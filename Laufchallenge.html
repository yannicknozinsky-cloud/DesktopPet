<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Run Eintrag</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: system-ui, sans-serif; margin:20px; background:#f7f7f7; }
button { padding:8px 12px; margin:5px; cursor:pointer; }
canvas { background:white; border:1px solid #ddd; border-radius:5px; padding:10px; }

.header { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
.dropbtn { background-color:#333; color:white; padding:8px 12px; font-size:16px; border:none; cursor:pointer; }
.dropdown { position:relative; }
.dropdown-content { display:none; position:absolute; left:0; top:100%; background-color:white; min-width:160px; box-shadow:0 8px 16px rgba(0,0,0,0.2); }
.dropdown-content a { color:black; padding:10px; text-decoration:none; display:block; }
.dropdown-content a:hover { background:#eee; }
.dropdown:hover .dropdown-content { display:block; }
/* Popup */
.modal {
  display:none;
  position:fixed;
  z-index:100;
  left:0; top:0;
  width:100%; height:100%;
  overflow:auto;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background:#fff;
  margin:10% auto;
  padding:20px;
  border-radius:5px;
  width:300px;
}
.modal-content h2 { margin-top:0; }
.modal-content input, .modal-content select { width:100%; margin-bottom:10px; padding:5px; font-size:16px; }
.modal-close { float:right; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<div class="header">
    <div class="dropdown">
        <button class="dropbtn">‚ò∞</button>
        <div class="dropdown-content">
            <a href="index.html">‚ûú] Log out</a>
            <a href="ToDo.html">üìù To Do</a>
            <a href="FCE.html">‚öΩÔ∏é Platzbelegung</a>
            
            <a href="LoginPlayer.html">PlayerLogin</a>
            
        </div>
    </div>
</div>

<h1>Run Eintrag & Gruppen√ºbersicht</h1>
<canvas id="groupChart" width="600" height="400"></canvas>
<button id="openModal">Neuen Run eintragen</button>
<button id="openPlayerModal">Neuer Spieler</button>

<!-- Popup -->
<div class="modal" id="runModal">
  <div class="modal-content">
    <span class="modal-close" id="closeModal">&times;</span>
    <h2>Neuen Run eintragen</h2>
    <input type="number" id="distance" placeholder="Distanz (m)" min="0" step="0.1">
    <select id="playerSelect">
      <option value="">Spieler w√§hlen</option>
    </select>
    <button id="saveRun">Speichern</button>
  </div>
</div>

<div class="modal" id="PlayerModal">
  <div class="modal-content">
    <span class="modal-close" id="closePlayerModal">&times;</span>
    <h2>Neuen Spieler</h2>
    <input type="text" id="gruppe" placeholder="Gruppe" >
     <input type="text" id="name" placeholder="name" >
    <button id="savePlayer">Speichern</button>
  </div>
</div>


<h2>Alle Runs</h2>
<table id="runsTable" border="1" cellspacing="0" cellpadding="5">
  <thead>
    <tr>
      <th>Spieler</th>
      <th>Gruppe</th>
      <th>Distanz (m)</th>
      <th>Datum</th>
    </tr>
  </thead>
  <tbody>
    <!-- L√§uft dynamisch -->
  </tbody>
</table>
<script>
const supabaseUrl = 'https://qkmtybzdthrpjfkbgskw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrbXR5YnpkdGhycGpma2Jnc2t3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODI3ODIsImV4cCI6MjA4MzQ1ODc4Mn0.VO1Bz0vKO4xTrcu-XCsZlrF4HgvgdbGLz3KKFRfG0Do';

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Modal
const modal = document.getElementById('runModal');
const openBtn = document.getElementById('openModal');
const closeBtn = document.getElementById('closeModal');
const saveBtn = document.getElementById('saveRun');
const playerSelect = document.getElementById('playerSelect');

openBtn.onclick = () => modal.style.display='block';
closeBtn.onclick = () => modal.style.display='none';
window.onclick = e => { if(e.target == modal) modal.style.display='none'; }


const addplayermodal = document.getElementById('PlayerModal');
const openPlayerBtn = document.getElementById('openPlayerModal');
const closePlayerBtn = document.getElementById('closePlayerModal');
const savePlayerBtn = document.getElementById('savePlayer');
openPlayerBtn.onclick = () => addplayermodal.style.display='block';
closePlayerBtn.onclick = () => addplayermodal.style.display='none';
window.onclick = e => { if(e.target == addplayermodal) addplayermodal.style.display='none'; }




let groupChart; // globale Chart.js Instanz


// Spieler laden
async function loadPlayers(){
    const {data, error} = await supabaseClient.from('player').select('id, Name').order('Name');
    if(error){ console.error(error); return; }
    data.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.Name;
        playerSelect.appendChild(opt);
    });
}

// Runs pro Gruppe laden und Chart zeichnen/aktualisieren
async function loadRunsByGroup(){
    const { data: runs, error } = await supabaseClient
        .from('RUN')
        .select('distance, player (id, Name, Group)');

    if(error){ console.error(error); return; }

    // Distanz pro Gruppe summieren
    const groupTotals = {};
    runs.forEach(run => {
        const group = run.player.Group || 'Unbekannt';
        if(!groupTotals[group]) groupTotals[group] = 0;
        groupTotals[group] += parseFloat(run.distance);
    });

    const labels = Object.keys(groupTotals);
    const values = Object.values(groupTotals);

    const ctx = document.getElementById('groupChart').getContext('2d');

    if(groupChart){
        // Update bestehender Chart
        groupChart.data.labels = labels;
        groupChart.data.datasets[0].data = values;
        groupChart.update();
    } else {
        // Neuer Chart
        groupChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Summe der Distanz (m)',
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Distanz in KM' }
                    },
                    x: {
                        title: { display: true, text: 'Gruppe' }
                    }
                }
            }
        });
    }
    loadAllRuns()
}

// Run speichern
saveBtn.onclick = async ()=>{
    const distance = parseFloat(document.getElementById('distance').value);
    const playerId = parseInt(playerSelect.value);
    const date = new Date().toISOString();

    if(isNaN(distance) || isNaN(playerId)){
        alert('Bitte Distanz und Spieler ausw√§hlen');
        return;
    }

    const {data, error} = await supabaseClient.from('RUN').insert([{distance, player: playerId, date}]);
    if(error){ 
        alert('Fehler beim Speichern: '+error.message);
        console.error(error);
    } else {
        alert('Run gespeichert!');
        modal.style.display='none';
        document.getElementById('distance').value='';
        playerSelect.value='';
        loadRunsByGroup(); // Chart sofort aktualisieren
    }
}

// Alle Runs laden und Tabelle f√ºllen
async function loadAllRuns(){
    const { data: runs, error } = await supabaseClient
        .from('RUN')
        .select('distance, date, player (Name, Group)')
        .order('date', { ascending: false }); // Neueste zuerst

    if(error){ console.error(error); return; }

    const tbody = document.querySelector('#runsTable tbody');
    tbody.innerHTML = ''; // vorher leeren

    runs.forEach(run => {
        const tr = document.createElement('tr');
        const nameTd = document.createElement('td');
        nameTd.textContent = run.player?.Name || 'Unbekannt';
        const groupTd = document.createElement('td');
        groupTd.textContent = run.player?.Group || 'Unbekannt';
        const distanceTd = document.createElement('td');
        distanceTd.textContent = run.distance;
        const dateTd = document.createElement('td');
        const d = new Date(run.date);
        dateTd.textContent = d.toLocaleString(); // sch√∂n formatiert
        tr.append(nameTd, groupTd, distanceTd, dateTd);
        tbody.appendChild(tr);
    });
}


savePlayerBtn.onclick = async () => {
    const name = document.getElementById('name').value.trim();
    const gruppe = document.getElementById('gruppe').value.trim();

    if (!name || !gruppe) {
        alert('Bitte Namen und Gruppe eingeben');
        return;
    }

    const { data, error } = await supabaseClient
        .from('player')
        .insert([{ Name: name, Group: gruppe }]);

    if (error) { 
        alert('Fehler beim Speichern: ' + error.message);
        console.error(error);
    } else {
        alert('Spieler gespeichert!');
        modal.style.display = 'none';
        document.getElementById('distance').value = '';
        playerSelect.value = '';
        loadRunsByGroup(); // Chart sofort aktualisieren
    }
}


// Initial laden
loadPlayers();
loadRunsByGroup();

</script>

</body>
</html>
